name: CI/CD

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    environment: OpenSource
    name: Test
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/determinate-nix-action@v3



    # - name: Build
    #   run: nix build .#packages.x86_64-linux.default

    - name: Run tests
      run: nix develop --command 'make' test test-valgrind

  cross-compile:
    environment: OpenSource
    name: Cross-compile
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64-linux, aarch64-linux, x86_64-darwin, aarch64-darwin]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/determinate-nix-action@v3

    - name: Build cross-compiled binary
      run: nix build .#packages.x86_64-linux.${{ matrix.target }}

    - name: Upload build artifact
      uses: actions/upload-artifact@v5
      with:
        name: try-${{ matrix.target }}
        path: result/bin/try
        retention-days: 7

  release:
    environment: OpenSource
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: cross-compile
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download all build artifacts
      uses: actions/download-artifact@v5
      with:
        path: ./artifacts

    - name: Prepare release assets
      run: |
        cd ./artifacts
        for dir in try-*; do
          if [ -d "$dir" ]; then
            chmod +x "$dir/try"
            tar -czf "${dir}.tar.gz" -C "$dir" "try"
          fi
        done
        ls -la *.tar.gz

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./artifacts/*.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  flakehub-publish:
    environment: OpenSource
    name: Publish to FlakeHub
    if: startsWith(github.ref, 'refs/tags/')
    needs: release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/determinate-nix-action@v3

    - name: Publish to FlakeHub
      uses: DeterminateSystems/flakehub-push@main
      with:
        name: ${{ github.repository }}
        visibility: public
        rolling: true

  aur-publish:
    name: Publish to AUR
    if: startsWith(github.ref, 'refs/tags/')
    needs: release
    runs-on: ubuntu-latest
    container: archlinux:latest
    environment: OpenSource

    steps:
    - name: Install dependencies
      run: pacman -Sy --noconfirm git openssh pacman-contrib base-devel sudo

    - name: Setup build user
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fix permissions
      run: chown -R builder:builder .

    - name: Update PKGBUILD version and checksums
      run: |
        su builder -c '
          VERSION=$(cat VERSION | tr -d "\n")
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
          updpkgsums
          makepkg --printsrcinfo > .SRCINFO
        '

    - name: Publish to AUR
      uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
      with:
        pkgname: try-cli
        pkgbuild: ./PKGBUILD
        assets: .SRCINFO
        commit_username: ${{ secrets.AUR_USERNAME }}
        commit_email: ${{ secrets.AUR_EMAIL }}
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "Update to ${{ github.ref_name }}"
        force_push: true